datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// =============================================================================
// Phase 1: Global Registry
// =============================================================================
// This table lives in the public schema. It acts as the "map" that tells
// the application which random schema name belongs to which user.

model Account {
  id                Int       @id @default(autoincrement())
  userId            String    @unique @default(uuid()) @db.Uuid
  email             String    @unique
  username          String    @unique
  passwordHash      String    @map("password_hash")
  tenantSchemaName  String    @unique @map("tenant_schema_name")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz

  // Encryption: Password-wrapped master key
  encryptedMasterKey  Bytes?    @map("encrypted_master_key")
  kekSalt             Bytes?    @map("kek_salt")
  kekWrapIv           Bytes?    @map("kek_wrap_iv")
  kekIterations       Int       @default(600000) @map("kek_iterations")

  // Encryption: Recovery-wrapped master key (independent backup path)
  recoveryWrappedMK   Bytes?    @map("recovery_wrapped_mk")
  recoveryWrapIv      Bytes?    @map("recovery_wrap_iv")

  encryptionEnabled   Boolean   @default(false) @map("encryption_enabled")

  sessions          Session[]

  @@map("accounts")
}

// =============================================================================
// Sessions (for traditional session-based auth)
// =============================================================================
// Sessions are stored in a separate table with a 1-hour expiration.
// The session token is stored in an HTTP-only cookie on the client.

model Session {
  id        Int      @id @default(autoincrement())
  token     String   @unique @default(uuid()) @db.Uuid
  accountId Int      @map("account_id")
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  account   Account  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

// =============================================================================
// Schema Counter (for generating unique schema names)
// =============================================================================
// Used to generate sequential, unique tenant schema names

model SchemaCounter {
  id            Int      @id @default(1)
  currentNumber Int      @default(0) @map("current_number")
  updatedAt     DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("schema_counter")
}
